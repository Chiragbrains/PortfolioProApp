# Setting Up Your Supabase Project for the Stock Portfolio App

**Welcome & How It Works**

Welcome to the Stock Portfolio Tracker! This application is designed to help you monitor your stock and ETF investments directly from your device (web or mobile).

*   **Your Data, Your Database:** Unlike many apps, this one connects *directly* to **your own private Supabase project**. Supabase provides a standard, secure PostgreSQL database that you control.
*   **No App Hosting Needed:** You **do not** need to host the application code itself. You only need to set up the free Supabase database by following the steps below. The app runs locally in your browser or on your device.
*   **Privacy Focused:** Your portfolio data and Supabase credentials (URL, Anon Key) are stored locally on your device/browser and are **never** sent to any central server managed by the app developer.

**High-Level Features:**

*   Track stock, ETF, and cash positions across multiple accounts.
*   View consolidated portfolio summaries and performance (P&L, percentages).
*   Group and view holdings by brokerage account.
*   Visualize your portfolio's value over time with a history chart.
*   Import your holdings easily from an Excel file.
*   Automatic background data refresh (via your Supabase Edge Function and Cron Job).

**Important Note on Data Refresh:** This application is designed to be efficient. It will only attempt to fetch fresh stock prices from Yahoo Finance via the Edge Function if the last data refresh (recorded in your `portfolio_history` table) was more than 2 hours ago. Otherwise, it will use the most recently cached prices stored in your `stock_cache` table. The scheduled task (Cron Job) in Step 5 ensures this data is updated automatically in the background, even when you are not using the app.

---

## Setup Guide

Follow these steps carefully to create and configure your own Supabase database.

**Estimated Time:** 15-20 minutes

**Prerequisites:** A Supabase account (free tier is sufficient). Sign up at supabase.com.

---

### Step 1: Create a New Supabase Project

1.  Log in to your Supabase account.
2.  Click on "**New project**".
3.  Choose an organization.
4.  Enter a **Project Name** (e.g., "My Stock Portfolio").
5.  Generate or enter a secure **Database Password** (save this somewhere safe, though the app won't need it directly).
6.  Select a **Region** closest to you.
7.  Choose the **Free Plan**.
8.  Click "**Create new project**" and wait for it to be set up.

---

### Step 2: Create Required Database Tables & Functions

You need to create three tables (`stocks`, `stock_cache`, `portfolio_history`) and a helper function in your Supabase PostgreSQL database.

1.  Once your project is ready, navigate to the **SQL Editor** in the left sidebar.
2.  Click "**New query**".
3.  Copy the entire SQL code block below, paste it into the query editor, and click "**RUN**".

    ```sql
    -- 1. Create the 'stocks' table to hold your portfolio positions
    CREATE TABLE public.stocks (
      id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
      created_at timestamp with time zone DEFAULT now() NOT NULL,
      ticker text NOT NULL,
      account text NOT NULL,
      quantity numeric NOT NULL,
      cost_basis numeric NOT NULL,
      type text NOT NULL, -- e.g., 'stock', 'etf', 'cash'
      updated_at timestamp with time zone DEFAULT now() NOT NULL
    );

    -- Add comments for clarity (optional)
    COMMENT ON COLUMN public.stocks.type IS 'Type of asset (e.g., stock, etf, cash)';

    -- Create a unique constraint to prevent duplicate ticker/account combinations
    ALTER TABLE public.stocks
      ADD CONSTRAINT stocks_ticker_account_unique UNIQUE (ticker, account);

    -- 2. Create the 'stock_cache' table to store recent prices
    CREATE TABLE public.stock_cache (
      ticker text PRIMARY KEY,
      current_price numeric,
      last_refreshed timestamp with time zone
    );

    -- 3. Create the 'portfolio_history' table for daily snapshots
    CREATE TABLE public.portfolio_history (
      id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
      date date NOT NULL,
      total_value numeric, -- Represents non-cash value
      total_cost_basis numeric, -- Represents non-cash cost basis
      total_pnl numeric, -- Represents overall P&L (including cash impact)
      cash_value numeric, -- Stores the cash value separately
      created_at timestamp with time zone DEFAULT now() NOT NULL -- Tracks when the snapshot was last updated/created
    );

    -- Add a unique constraint on the date column for daily upserts
    ALTER TABLE public.portfolio_history
      ADD CONSTRAINT portfolio_history_date_unique UNIQUE (date);

    -- 4. Create the truncate_stocks function needed by the app
    -- This allows truncating the table via RPC without granting full DELETE privileges
    CREATE OR REPLACE FUNCTION truncate_stocks()
    RETURNS void
    LANGUAGE plpgsql
    AS $$
    BEGIN
      -- Check if the user has permission (e.g., service_role or specific role)
      -- This is a basic example; adjust permissions as needed.
      IF session_user = 'postgres' OR current_user = 'postgres' OR auth.role() = 'service_role' THEN
        TRUNCATE TABLE public.stocks;
      ELSE
        RAISE EXCEPTION 'Permission denied to truncate stocks table.';
      END IF;
    END;
    $$;

    -- Grant execute permission to authenticated users and service role
    GRANT EXECUTE ON FUNCTION public.truncate_stocks() TO authenticated;
    GRANT EXECUTE ON FUNCTION public.truncate_stocks() TO service_role;
    -- Also grant to anon if needed, but be cautious
    GRANT EXECUTE ON FUNCTION public.truncate_stocks() TO anon;
    ```

4.  Verify that the query ran successfully and the three tables (`stocks`, `stock_cache`, `portfolio_history`) appear in the **Table Editor**.

---

### Step 3: Enable Row Level Security (RLS) and Create Policies

RLS protects your data. These policies allow the app (using your public `anon` key) to access the data it needs.

1.  In the left sidebar, navigate to the **SQL Editor**.
2.  Click "**New query**".
3.  Copy the entire SQL code block below, paste it into the query editor, and click "**RUN**".

    ```sql
    -- Enable RLS for each table
    ALTER TABLE public.stocks ENABLE ROW LEVEL SECURITY;
    ALTER TABLE public.stock_cache ENABLE ROW LEVEL SECURITY;
    ALTER TABLE public.portfolio_history ENABLE ROW LEVEL SECURITY;

    -- Grant permissions to the 'anon' role (used by the app)
    -- Note: 'public' role implicitly includes 'anon'

    -- Policies for 'stocks' table (Allow all actions for simplicity)
    CREATE POLICY "Allow ALL access on stocks"
      ON public.stocks
      FOR ALL -- Covers SELECT, INSERT, UPDATE, DELETE
      USING (true) -- Allows the action if this condition is true
      WITH CHECK (true); -- Enforces this condition on INSERT/UPDATE

    -- Policies for 'stock_cache' table (Allow read, insert, update)
    CREATE POLICY "Allow read access on stock_cache"
      ON public.stock_cache
      FOR SELECT
      USING (true);

    CREATE POLICY "Allow insert/update access on stock_cache"
      ON public.stock_cache
      FOR ALL -- Covers INSERT, UPDATE (needed for upsert)
      USING (true)
      WITH CHECK (true);

    -- Policies for 'portfolio_history' table (Allow read, insert, update)
    CREATE POLICY "Allow read access on portfolio_history"
      ON public.portfolio_history
      FOR SELECT
      USING (true);

    CREATE POLICY "Allow insert/update access on portfolio_history"
      ON public.portfolio_history
      FOR ALL -- Covers INSERT, UPDATE (needed for upsert)
      USING (true)
      WITH CHECK (true);

    -- Grant usage on schema and sequences if needed (often default, but good practice)
    GRANT USAGE ON SCHEMA public TO anon;
    GRANT ALL ON ALL TABLES IN SCHEMA public TO anon;
    GRANT ALL ON ALL SEQUENCES IN SCHEMA public TO anon;
    GRANT ALL ON ALL FUNCTIONS IN SCHEMA public TO anon; -- If using RPC functions accessible by anon
    ```

4.  Verify that the query ran successfully. You can double-check in **Authentication** -> **Policies** that RLS is enabled for the tables and policies exist.

---

### Step 4: Create the Supabase Edge Function

This function runs on Supabase servers to fetch live stock prices and update your cache and history.

1.  In the left sidebar, navigate to **Edge Functions**.
2.  Click "**Create function**".
3.  Enter the **Function name**: `dynamic-service` (use this exact name).
4.  Click "**Create function**".
5.  You'll be shown an editor with default code. **Delete all the default code**.
6.  **Copy the entire Edge Function code provided below** and paste it into the editor:

    ```typescript
    // --- PASTE YOUR EDGE FUNCTION CODE HERE ---
    // Make sure it's the version that correctly calculates
    // non-cash vs cash values and updates created_at on upsert.
    // Example structure:
    import { serve } from 'https://deno.land/std@0.177.0/http/server.ts';
    import { createClient, SupabaseClient } from 'https://esm.sh/@supabase/supabase-js@2';
    import { corsHeaders } from '../_shared/cors.ts';

    // ... Helper functions (updateStockCache, fetchFromCache, fetchCurrentPrice) ...

    serve(async (req) => {
      // ... CORS handling ...
      try {
        // ... Initialize Supabase client using SERVICE_ROLE_KEY ...
        // ... Fetch stocks ...
        // ... Loop through stocks, calculate values (overall, cash, non-cash) ...
        // ... Upsert to portfolio_history (including created_at) ...
        // ... Return response ...
      } catch (error) {
        // ... Error handling ...
      }
    });
    // --- END OF EDGE FUNCTION CODE ---
    ```

7.  Click "**Save and Deploy**" (or Deploy). Wait for the deployment to complete.
8.  **Set Environment Variables:**
    *   Go to **Project Settings** -> **Edge Functions**.
    *   Under **Environment Variables**, click "**Add new variable**".
    *   Add `SUPABASE_URL`: Find this in **Project Settings** -> **API** -> **Project URL**.
    *   Add `SUPABASE_SERVICE_ROLE_KEY`: Find this in **Project Settings** -> **API** -> **Project API keys** -> `service_role` key (**Keep this secret!**).
    *   Click "**Save**".

---

### Step 5: Schedule the Edge Function (Cron Job)

This automatically runs your Edge Function (e.g., daily or every few hours) **to keep price data fresh and build the data needed for the history chart, even when you are not using the application.**

1.  In the left sidebar, navigate to **Database** -> **Functions**.
2.  Click "**Create a new function**".
3.  Select the **Cron** template (or search for `pg_cron`).
4.  **Function Name:** `schedule_price_updates` (or similar).
5.  **Return type:** `bigint` (or `void`).
6.  **Definition:** Replace the default function body with the following, adjusting the schedule as needed:

    ```sql
    BEGIN
      -- Schedule the 'dynamic-service' function to run
      -- Example: Runs every 4 hours ('0 */4 * * *')
      -- Example: Runs once a day at 2 AM UTC ('0 2 * * *')
      -- Choose a schedule that fits your needs and Supabase's free tier limits.
      RETURN cron.schedule(
        '[YOUR PREFERRED CRON SCHEDULE]', -- e.g., '0 */4 * * *' for every 4 hours
        $$ SELECT net.http_post( -- Use net.http_post for Edge Functions
            url:='[YOUR SUPABASE PROJECT URL]/functions/v1/dynamic-service',
            headers:='{"Authorization": "Bearer [YOUR SUPABASE SERVICE ROLE KEY]"}'::jsonb,
            body:='{}'::jsonb -- Add body if your function expects one
           );
        $$
      );
    END;
    ```

7.  **Important:**
    *   Replace `[YOUR PREFERRED CRON SCHEDULE]` with your desired schedule (e.g., `'0 */4 * * *'` to run every 4 hours). See crontab.guru for help. Be mindful of free tier invocation limits.
    *   Replace `[YOUR SUPABASE PROJECT URL]` with your actual Project URL (from Step 4).
    *   Replace `[YOUR SUPABASE SERVICE ROLE KEY]` with your actual `service_role` key (from Step 4). **Make sure this key stays within the SQL definition and is not exposed elsewhere.**
8.  Click "**Confirm**" to create the scheduling function.
9.  **Enable pg_cron Extension:**
    *   Go to **Database** -> **Extensions**.
    *   Search for `pg_cron`.
    *   Click the toggle to **Enable** it if it's not already enabled.
10. **Run the Scheduling Function Once:**
    *   Go back to **Database** -> **Functions**.
    *   Select the `schedule_price_updates` function you created.
    *   Click "**Execute function**" (or use the SQL Editor: `SELECT schedule_price_updates();`). This registers the job with `pg_cron`. You only need to do this once.

---

### Step 6: Find Your Project URL and Anon Key

The application needs these to connect to *your* Supabase project.

1.  In the left sidebar, go to **Project Settings** (the gear icon).
2.  Select **API**.
3.  Under **Project API keys**:
    *   Copy the **URL**. This is your Supabase Project URL.
    *   Copy the **`anon` `public`** key. This is your Supabase Anon Key.
4.  Keep these copied values ready for the next step. **Do not use the `service_role` key in the app.**

---

### Step 7: Enter Credentials in the Stock Portfolio App

1.  Open the Stock Portfolio App.
2.  You should see a setup screen asking for your Supabase details.
3.  Carefully paste the **Project URL** you copied into the "Supabase Project URL" field.
4.  Carefully paste the **Anon Key** you copied into the "Supabase Anon Key" field.
5.  Click "**Connect & Save**".

---

**Setup Complete!**

If the connection is successful, the app should load and function using your own Supabase database. If you encounter errors, double-check that you copied the URL and Anon Key correctly and that all tables, RLS policies, and the Edge Function were set up exactly as described. Check the Edge Function logs and Cron Job history in your Supabase dashboard for troubleshooting.
